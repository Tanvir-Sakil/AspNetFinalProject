
@{
    ViewData["Title"] = "Units";
   
}
@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.min.css">
}
<div class="row">
    <div class="col-md-8">
        <div id="unitTable">
            <table id="units" class="table table-bordered">
                <thead>
                    <tr>
                        <th>#SN</th>
                        <th>Unit Name</th>
                        <th>Status</th>
                        <th>Created Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <div class="col-md-4">
        <!-- Render reusable unit creation form -->
        <div id="createForm">
            <partial name="_UnitAddForm" />
        </div>
    </div>
</div>
<!-- Container for edit modal -->
<div id="editModalContainer">
    
</div>
@section Scripts {
    <!-- DataTables and dependencies -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            // Initialize DataTable with AJAX source
            var table = $('#units').DataTable({
                processing: true,
                serverSide: true,				
                responsive: true,
                lengthChange: true,
                autoWidth: false,
                lengthMenu: [
                    [10, 25, 50, -1],
                    [10, 25, 50, 'All']
                ],
                layout: {
                    topStart: 'buttons',
                    topEnd: 'search',
                },
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                layout: {
                    topStart: 'buttons',
                    topEnd: 'search',
                },
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                ajax: {
                    url: '/Settings/Unit/GetUnitListJson', 
                    type: 'POST',
                    contentType: "application/json",
                    dataType: "json",
                    data:function(d)
                    {
                        d.SearchItem={};
                        return JSON.stringify(d);
                    }
                
                },
                columns: [
                    { data: 'serialNumber' },
                    { data: 'name' },
                    { data: 'isActive', render: function (data) {
                        return data ? 'Active' : 'Inactive';
                    }},
                    { data: 'createdDate' },
                    {
                        data: 'id',
                        orderable: false,
                        render: function (data) {
                            return `<button class='btn btn-info btn-sm edit-btn' data-id='${data}'>Edit</button>
                                    <button class='btn btn-danger btn-sm delete-btn' data-id='${data}'>Delete</button>`;
                        }
                    }
                ],
                layout: {
                    topStart: 'buttons',
                    topEnd: 'search'
                },
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
            });

            // Submit create form
            $(document).on('submit', '#createUnitForm', function (e) {
                e.preventDefault();
                $.ajax({
                    url: '/Settings/Unit/Add',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function () {
                        table.ajax.reload(null, false);
                        $('#createUnitForm')[0].reset();
                    },
                    error: () => alert("Error while creating unit")
                });
            });

            // Handle edit button click
            $(document).on("click", ".edit-btn", function () {
            const id = $(this).data("id");
            $.get(`/Settings/Unit/GetUnit/${id}`, function (modalHtml) {
                $('#editModalContainer').html(modalHtml);
                const modalEl = document.getElementById('editModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            });
        });

            // Handle delete button click
            $(document).on("click", ".delete-btn", function () {
                const id = $(this).data("id");
                if (confirm("Are you sure to delete?")) {
                    $.post(`/Settings/Unit/Delete`, { id }, function () {
                        table.ajax.reload(null, false);
                    });
                }
            });
        });
    </script>

    <script>
        // Handle edit form submission using JSON
        $(document).on('submit', '#editUnitForm', function (e) {
            e.preventDefault();

            const Data = {
                id: $('#editUnitForm [name="Id"]').val(),
                name: $('#editUnitForm [name="Name"]').val(),
                isActive: $('#editUnitForm [name="IsActive"]').val() === "true"
            };

            $.ajax({
                url: '/Settings/Unit/Edit',
                type: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify(Data), 
                success: function (res) {
                    console.log("Update response:", res);
                    const modalEl = document.getElementById('editModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();

                    $('#units').DataTable().ajax.reload(null, false);
                },
                error: function (xhr, status, error) {
                    console.error("Update failed:", xhr.responseText);
                    alert("Error while updating unit");
                }
            });
        });
    </script>


}

