@{
    ViewData["Title"] = "Supplier List";
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.min.css" />

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
        }

        h2 {
            color: #212529;
            font-weight: 700;
        }

        .btn-primary {
            background: linear-gradient(to right, #0d6efd, #0a58ca);
            font-weight: 600;
            border: none;
        }

            .btn-primary:hover {
                background: linear-gradient(to right, #0a58ca, #084298);
                box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
            }

        .table thead th {
            background: linear-gradient(to right, #343a40, #495057);
            color: white;
            text-align: center;
        }

        .table tbody td {
            vertical-align: middle;
            text-align: center;
        }

        .table-hover tbody tr:hover {
            background-color: #f1f3f5;
        }

        .dataTables_wrapper {
            margin-top: 1rem;
        }

        .modal-header {
            background-color: #0d6efd;
            color: white;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }

        .modal-content {
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .form-control {
            border-radius: 0.5rem;
        }

        .btn-outline-danger {
            border-radius: 6px;
        }

            .btn-outline-danger:hover {
                background-color: #dc3545;
                color: white;
            }

        .dt-buttons .btn {
            background-color: #0d6efd !important;
            color: white !important;
            border-radius: 4px;
            margin-right: 5px;
        }

            .dt-buttons .btn:hover {
                background-color: #084298 !important;
            }
    </style>
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-truck me-2"></i>Supplier Management</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#supplierModal">
            <i class="fas fa-plus me-1"></i> Add New Supplier
        </button>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <table id="supplierTable" class="table table-bordered table-hover table-striped w-100">
                <thead>
                    <tr>
                        <th>#SN</th>
                        <th>Supplier ID</th>
                        <th>Name</th>
                        <th>Company</th>
                        <th>Mobile</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<partial name="_AddSupplierModal" />
<partial name="_ModalPartial" />

@section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>

    <script>
        const table = $('#supplierTable').DataTable({
            processing: true,
            serverSide: true,
            responsive: true,
            autoWidth: false,
            scrollX: true,
            lengthMenu: [
                [10, 25, 50, -1],
                [10, 25, 50, 'All']
            ],
            layout: {
                topStart: ['pageLength', 'buttons'],
                topEnd: 'search'
            },
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
            ajax: '/UserManagement/Supplier/GetAll',
            columns: [
                { data: null, render: (data, type, row, meta) => meta.row + 1 },
                { data: 'id' },
                { data: 'supplierName' },
                { data: 'company' },
                { data: 'mobile' },
                { data: 'address' },
                {
                    data: 'status',
                    render: data => data === 'Active'
                        ? '<span class="badge bg-success">Active</span>'
                        : '<span class="badge bg-secondary">Inactive</span>'
                },
                {
                    data: 'id',
                    render: id => `
                        <button class='btn btn-outline-danger btn-sm delete-supplier' data-id='${id}' title="Delete">
                            <i class='fas fa-trash-alt'></i>
                        </button>`
                }
            ]
        });

        $('#supplierForm').submit(function (e) {
            e.preventDefault();
            const formData = {
                SupplierName: $('input[name="SupplierName"]').val(),
                Mobile: $('input[name="Mobile"]').val(),
                Company: $('input[name="Company"]').val(),
                Email: $('input[name="Email"]').val(),
                Address: $('input[name="Address"]').val(),
                OpeningBalance: $('input[name="OpeningBalance"]').val()
            };

            $.ajax({
                url: '/UserManagement/Supplier/Add',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function () {
                    $('#supplierModal').modal('hide');
                    table.ajax.reload();
                }
            });
        });

        $('#supplierTable').on('click', '.delete-supplier', function () {
            const id = $(this).data("id");
            $('#modal-delete .modal-body p').text("Are you sure you want to delete this supplier?");
            $('#delete-id').val(id);
            $('#delete-form').attr('action', '/UserManagement/Supplier/delete');
            new bootstrap.Modal(document.getElementById('modal-delete')).show();
        });

        $('#delete-button').click(function () {
            const id = $('#delete-id').val();
            const token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: `/UserManagement/Supplier/delete/${id}`,
                type: 'POST',
                headers: { 'RequestVerificationToken': token },
                success: function () {
                    const modalEl = document.getElementById('modal-delete');
                    bootstrap.Modal.getInstance(modalEl).hide();
                    table.ajax.reload(null, false);
                    alert('Supplier deleted successfully.');
                },
                error: function () {
                    alert('Failed to delete Supplier.');
                }
            });
        });
    </script>
}
